class PayPalFastlane{constructor(e){this.containerSelector=e,this.fastlaneInstance=null,this.profileData=null,this.paymentToken=null,this.savedCardHtml="",this.paymentMethodId="angelleye_ppcp_fastlane",this.isCardDetailsRestored=!1,this.isPaymentMethodSet=!1,this.fastlaneCardComponent=null}async initialize(){try{this.fastlaneInstance=await angelleye_paypal_sdk.Fastlane({}),this.fastlaneInstance.setLocale("en_us"),this.bindEmailLookupEvent(),this.bindWooCommerceEvents()}catch(e){console.error("Failed to initialize Fastlane:",e)}}async lookupCustomerByEmail(e){try{let{customerContextId:t}=await this.fastlaneInstance.identity.lookupCustomerByEmail(e);return t}catch(a){return console.error("Error looking up customer by email:",a),null}}async authenticateCustomer(e){try{let{authenticationState:t,profileData:a}=await this.fastlaneInstance.identity.triggerAuthenticationFlow(e);return"succeeded"===t&&(this.profileData=a,this.paymentToken=a.card?.id||null,this.updateWooCheckoutFields(a)),"succeeded"===t}catch(i){return console.error("Error authenticating customer:",i),!1}}async renderCardDetails(){this.profileData?.card?(this.savedCardHtml=`
                <div id="paypal-fastlane-saved-card" class="fastlane-card">
                    <div class="fastlane-card-number">•••• •••• •••• ${this.profileData.card.paymentSource.card.lastDigits}</div>
                    <div class="fastlane-card-expiry">Expires: ${this.profileData.card.paymentSource.card.expiry}</div>
                    <button id="change-card">Change Card</button>
                </div>
            `,jQuery(this.containerSelector).html(this.savedCardHtml),this.bindChangeCardEvent(),await this.initializeFastlaneCardComponent(),this.bindPlaceOrderEvent(this.fastlaneCardComponent)):this.renderCardForm()}async initializeFastlaneCardComponent(){try{if(!this.fastlaneCardComponent&&(this.fastlaneCardComponent=await this.fastlaneInstance.FastlaneCardComponent({fields:{cardholderName:{prefill:`${jQuery("#billing_first_name").val()} ${jQuery("#billing_last_name").val()}`,enabled:!0},phoneNumber:{enabled:!0,prefill:jQuery("#billing_phone").val()||""}}}),!this.fastlaneCardComponent))throw Error("FastlaneCardComponent initialization failed.")}catch(e){throw console.error("Error initializing FastlaneCardComponent:",e),e}}async renderCardForm(){try{await this.initializeFastlaneCardComponent(),this.fastlaneCardComponent.render(this.containerSelector),this.bindPlaceOrderEvent(this.fastlaneCardComponent)}catch(e){console.error("Error rendering card form:",e)}}restoreCardDetails(){let e=jQuery("#paypal-fastlane-saved-card");!e.length&&this.savedCardHtml?(jQuery(this.containerSelector).html(this.savedCardHtml),this.bindChangeCardEvent()):e.length||this.savedCardHtml||this.processEmailLookup().then(()=>{this.updateWooCheckoutFields(this.profileData)})}bindChangeCardEvent(){jQuery(document).on("click","#change-card",async e=>{e.preventDefault(),e.stopPropagation();try{let{selectedCard:t}=await this.fastlaneInstance.profile.showCardSelector();t&&(this.profileData.card=t,this.paymentToken=t.id,this.renderCardDetails())}catch(a){console.error("Error changing card:",a)}})}bindPlaceOrderEvent(e){jQuery(document.body).off("submit_angelleye_ppcp_fastlane").on("submit_angelleye_ppcp_fastlane",async t=>{angelleyeOrder.showProcessingSpinner(),t.preventDefault();try{let a=this.paymentToken;if(a)console.log("Using existing payment token:",a);else{let i=this.getBillingAddress(),n=this.getShippingAddress();if(!i||!n)throw Error("Billing or shipping address is missing.");if(!e)throw Error("FastlaneCardComponent is not initialized.");a=await e.getPaymentToken({billingAddress:i,shippingAddress:n}),this.paymentToken=a}if(!a)throw Error("Failed to retrieve payment token.");let s=angelleyeOrder.getCheckoutSelectorCss();if(angelleyeOrder.createHiddenInputField({fieldId:"fastlane_payment_token",fieldName:"fastlane_payment_token",fieldValue:a.id||a,appendToSelector:s}),!jQuery(s).hasClass("createOrder")){let r=angelleyeJsErrorLogger.generateErrorId();angelleyeJsErrorLogger.addToLog(r,"Fastlane Payment Started"),jQuery(s).addClass("createOrder"),await angelleyeOrder.createOrder({errorLogId:r}).then(e=>{e.redirected&&(window.location.href=e.url)})}}catch(l){console.error("Failed to place order:",l.message),angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError("Failed to place order: "+l.message)}})}getBillingAddress(){return{addressLine1:jQuery("#billing_address_1").val(),adminArea1:jQuery("#billing_state").val(),adminArea2:jQuery("#billing_city").val(),postalCode:jQuery("#billing_postcode").val(),countryCode:jQuery("#billing_country").val()}}getShippingAddress(){return{addressLine1:jQuery("#shipping_address_1").val(),adminArea1:jQuery("#shipping_state").val(),adminArea2:jQuery("#shipping_city").val(),postalCode:jQuery("#shipping_postcode").val(),countryCode:jQuery("#shipping_country").val()}}updateWooCheckoutFields(e){let t=(e,t)=>{t&&jQuery(e).val(t).trigger("change")},a=e.card?.paymentSource?.card?.billingAddress||{},i=e.shippingAddress?.address||{};t("#billing_first_name",e.email),t("#billing_first_name",e.name?.firstName),t("#billing_last_name",e.name?.lastName),t("#billing_address_1",a.addressLine1),t("#billing_city",a.adminArea2),t("#billing_postcode",a.postalCode),t("#billing_country",a.countryCode),t("#billing_state",a.adminArea1),t("#billing_phone",e.shippingAddress?.phoneNumber?.nationalNumber),t("#shipping_first_name",e.shippingAddress?.name?.firstName),t("#shipping_last_name",e.shippingAddress?.name?.lastName),t("#shipping_address_1",i.addressLine1),t("#shipping_city",i.adminArea2),t("#shipping_postcode",i.postalCode),t("#shipping_country",i.countryCode),t("#shipping_state",i.adminArea1),jQuery.ajax({url:fastlane_object.ajaxurl,method:"POST",data:{action:"angelleye_ppcp_save_fastlane_data",profileData:e},success:function(e){e.success?($("#place_order").length&&$("html, body").animate({scrollTop:$("#place_order").offset().top-500},1e3),$(document.body).trigger("update_checkout"),console.log("Checkout fields saved successfully.")):console.log("Failed to save checkout fields.")},error:function(){console.log("Error during AJAX request.")}}),this.setPaymentMethod(this.paymentMethodId)}setPaymentMethod(e){let t=jQuery(`#payment_method_${e}`);t.length>0&&(t.prop("checked",!0),this.isPaymentMethodSet=!0,jQuery("#payment_method_angelleye_ppcp_fastlane").trigger("click"))}async processEmailLookup(){let e=jQuery('input[name="fastlane-email"]').val();jQuery('input[name="billing_email"]').val(e);let t=await this.lookupCustomerByEmail(e);if(t){let a=await this.authenticateCustomer(t);a?this.renderCardDetails():this.renderCardForm()}else this.renderCardForm()}bindEmailLookupEvent(){jQuery(".fastlane-submit-button").off("click").on("click",async e=>{e.preventDefault();let t=jQuery(".fastlane-submit-button");t.prop("disabled",!0);try{await this.processEmailLookup(),this.isPaymentMethodSet||this.setPaymentMethod(this.paymentMethodId)}catch(a){console.error("Error during email lookup event:",a)}finally{t.prop("disabled",!1)}})}bindWooCommerceEvents(){jQuery(document.body).on("updated_checkout",()=>{this.isCardDetailsRestored=!1,this.isPaymentMethodSet=!1,this.restoreCardDetails(),setTimeout(()=>{this.isPaymentMethodSet||this.setPaymentMethod(this.paymentMethodId)},200)})}render(){this.profileData?.card?this.renderCardDetails():this.renderCardForm()}}