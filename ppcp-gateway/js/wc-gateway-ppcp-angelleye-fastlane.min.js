class PayPalFastlane{constructor(e){this.containerSelector=e,this.fastlaneInstance=null,this.profileData=null,this.paymentToken=null,this.savedCardHtml="",this.paymentMethodId="angelleye_ppcp_fastlane",this.isCardDetailsRestored=!1,this.isPaymentMethodSet=!1,this.fastlaneCardComponent=null}async initialize(){try{this.fastlaneInstance=await angelleye_paypal_sdk.Fastlane({}),this.fastlaneInstance.setLocale("en_us"),this.bindEmailLookupEvent(),this.bindWooCommerceEvents()}catch(e){console.error("Failed to initialize Fastlane:",e)}}async lookupCustomerByEmail(e){try{let{customerContextId:t}=await this.fastlaneInstance.identity.lookupCustomerByEmail(e);return t}catch(a){return console.error("Error looking up customer by email:",a),null}}async authenticateCustomer(e){try{let{authenticationState:t,profileData:a}=await this.fastlaneInstance.identity.triggerAuthenticationFlow(e);return"succeeded"===t&&(this.profileData=a,this.paymentToken=a.card?.id||null,this.updateWooCheckoutFields(a)),"succeeded"===t}catch(i){return console.error("Error authenticating customer:",i),!1}}async renderCardDetails(){this.profileData?.card?(this.savedCardHtml=`
                <div id="paypal-fastlane-saved-card" class="fastlane-card">
                    <div class="fastlane-card-number">•••• •••• •••• ${this.profileData.card.paymentSource.card.lastDigits}</div>
                    <div class="fastlane-card-expiry">Expires: ${this.profileData.card.paymentSource.card.expiry}</div>
                    <button id="change-card">Change Card</button>
                </div>
            `,jQuery(this.containerSelector).html(this.savedCardHtml),this.bindChangeCardEvent(),await this.initializeFastlaneCardComponent(),this.bindPlaceOrderEvent(this.fastlaneCardComponent)):this.renderCardForm()}async initializeFastlaneCardComponent(){try{if(!this.fastlaneCardComponent){let e=jQuery("#billing_first_name").length?"#billing_first_name":"#billing-first_name",t=jQuery("#billing_last_name").length?"#billing_last_name":"#billing-last_name",a=jQuery("#billing_phone").length?"#billing_phone":"#billing-phone",i=jQuery(e).val()?jQuery(e).val().trim():"",n=jQuery(t).val()?jQuery(t).val().trim():"",r=jQuery(a).val()?jQuery(a).val().trim():"",s={cardholderName:{enabled:!0,...i&&n?{prefill:`${i} ${n}`}:{}},phoneNumber:{enabled:!0,...r?{prefill:r}:{}}};if(this.fastlaneCardComponent=await this.fastlaneInstance.FastlaneCardComponent({fields:s}),!this.fastlaneCardComponent)throw Error("FastlaneCardComponent initialization failed.")}}catch(l){throw console.error("Error initializing FastlaneCardComponent:",l),l}}async renderCardForm(){try{await this.initializeFastlaneCardComponent(),this.fastlaneCardComponent.render(this.containerSelector),this.bindPlaceOrderEvent(this.fastlaneCardComponent)}catch(e){console.error("Error rendering card form:",e)}}restoreCardDetails(){let e=jQuery("#paypal-fastlane-saved-card");!e.length&&this.savedCardHtml?(jQuery(this.containerSelector).html(this.savedCardHtml),this.bindChangeCardEvent()):e.length||this.savedCardHtml||this.processEmailLookup().then(()=>{this.updateWooCheckoutFields(this.profileData)})}bindChangeCardEvent(){jQuery(document).on("click","#change-card",async e=>{e.preventDefault(),e.stopPropagation();try{let{selectedCard:t}=await this.fastlaneInstance.profile.showCardSelector();t&&(this.profileData.card=t,this.paymentToken=t.id,this.renderCardDetails())}catch(a){console.error("Error changing card:",a)}})}bindPlaceOrderEvent(e){jQuery(document.body).off("submit_angelleye_ppcp_fastlane").on("submit_angelleye_ppcp_fastlane",async t=>{if(jQuery("#fastlane-email").length>0&&""===jQuery("#fastlane-email").val().trim())throw jQuery("#fastlane-email").addClass("fastlane-input-error"),angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.removeError(),angelleyeOrder.showError("Email address is required in the Fastlane email field to continue."),Error("Email address is required in the Fastlane email field to continue.");jQuery("#fastlane-email").removeClass("fastlane-input-error"),t.preventDefault();try{let a=this.paymentToken;if(a)console.log("Using existing payment token:",a);else{let i=this.getBillingAddress(),n=this.getShippingAddress();if(!e)throw Error("FastlaneCardComponent is not initialized.");i&&0!==Object.keys(i).length&&i.addressLine1||(i={addressLine1:n.addressLine1||"",adminArea1:n.adminArea1||"",adminArea2:n.adminArea2||"",postalCode:n.postalCode||"",countryCode:n.countryCode||""}),n&&0!==Object.keys(n).length&&n.addressLine1||(n={addressLine1:i.addressLine1||"",adminArea1:i.adminArea1||"",adminArea2:i.adminArea2||"",postalCode:i.postalCode||"",countryCode:i.countryCode||""}),a=await e.getPaymentToken({billingAddress:i,shippingAddress:n}),this.paymentToken=a}if(!a)throw Error("Failed to retrieve payment token.");let r=angelleyeOrder.getCheckoutSelectorCss();if(angelleyeOrder.createHiddenInputField({fieldId:"fastlane_payment_token",fieldName:"fastlane_payment_token",fieldValue:a.id||a,appendToSelector:r}),!jQuery(r).hasClass("createOrder")){let s=angelleyeJsErrorLogger.generateErrorId();angelleyeJsErrorLogger.addToLog(s,"Fastlane Payment Started"),jQuery(r).addClass("createOrder"),await angelleyeOrder.createOrder({errorLogId:s}).then(e=>{e.redirected?window.location.href=e.url:(jQuery(".wc-block-components-checkout-place-order-button .wc-block-components-spinner").remove(),jQuery(".wc-block-components-checkout-place-order-button, .wp-block-woocommerce-checkout-fields-block #contact-fields, .wp-block-woocommerce-checkout-fields-block #billing-fields, .wp-block-woocommerce-checkout-fields-block #payment-method").unblock(),console.error("Failed to place order:",e.data.messages),angelleyeOrder.showError("Failed to place order: "+e.data.messages))})}}catch(l){jQuery(".wc-block-components-checkout-place-order-button .wc-block-components-spinner").remove(),angelleyeOrder.hideProcessingSpinner(),console.log(l)}})}getBillingAddress(){let e=jQuery("#billing_address_1").val(),t=jQuery("#billing_state").val(),a=jQuery("#billing_city").val(),i=jQuery("#billing_postcode").val(),n=jQuery("#billing_country").val();return!e&&jQuery("#billing-address_1").length>0&&(e=jQuery("#billing-address_1").val(),t=jQuery("#billing-state").val(),a=jQuery("#billing-city").val(),i=jQuery("#billing-postcode").val(),n=jQuery("#billing-country").val()),{addressLine1:e,adminArea1:t,adminArea2:a,postalCode:i,countryCode:n}}getShippingAddress(){let e=jQuery("#shipping_address_1").val(),t=jQuery("#shipping_state").val(),a=jQuery("#shipping_city").val(),i=jQuery("#shipping_postcode").val(),n=jQuery("#shipping_country").val();return!e&&jQuery("#shipping-address_1").length>0&&(e=jQuery("#shipping-address_1").val(),t=jQuery("#shipping-state").val(),a=jQuery("#shipping-city").val(),i=jQuery("#shipping-postcode").val(),n=jQuery("#shipping-country").val()),{addressLine1:e,adminArea1:t,adminArea2:a,postalCode:i,countryCode:n}}updateWooCheckoutFields(e){let t=(e,t)=>{t&&jQuery(e).val(t).trigger("change")},a=e.card?.paymentSource?.card?.billingAddress||{},i=e.shippingAddress?.address||{};t("#billing_first_name",e.name?.firstName),t("#billing_last_name",e.name?.lastName),t("#billing_address_1",a.addressLine1),t("#billing_city",a.adminArea2),t("#billing_postcode",a.postalCode),t("#billing_country",a.countryCode),t("#billing_state",a.adminArea1),t("#billing_phone",e.shippingAddress?.phoneNumber?.nationalNumber),t("#billing_email",e.email),t("#shipping_first_name",e.shippingAddress?.name?.firstName),t("#shipping_last_name",e.shippingAddress?.name?.lastName),t("#shipping_address_1",i.addressLine1),t("#shipping_city",i.adminArea2),t("#shipping_postcode",i.postalCode),t("#shipping_country",i.countryCode),t("#shipping_state",i.adminArea1),jQuery(document.body).trigger("custom_action_to_refresh_checkout",e),jQuery.ajax({url:fastlane_object.ajaxurl,method:"POST",data:{action:"angelleye_ppcp_save_fastlane_data",profileData:e},success:function(e){e.success&&jQuery("#place_order").length&&jQuery("html, body").animate({scrollTop:jQuery("#place_order").offset().top-500},1e3)},error:function(){console.log("Error during AJAX request.")}}),this.setPaymentMethod(this.paymentMethodId)}setPaymentMethod(e){let t=jQuery(`#payment_method_${e}`);t.length>0?(t.prop("checked",!0),this.isPaymentMethodSet=!0,jQuery("#payment_method_angelleye_ppcp_fastlane").trigger("click")):(jQuery("#radio-control-wc-payment-method-options-angelleye_ppcp_fastlane").prop("checked",!0),this.isPaymentMethodSet=!0,jQuery("#radio-control-wc-payment-method-options-angelleye_ppcp_fastlane").parent("label").parent("div").trigger("click"))}async processEmailLookup(){let e=jQuery('input[name="fastlane-email"]').val();jQuery('input[name="billing_email"]').val(e);let t=await this.lookupCustomerByEmail(e);if(t){let a=await this.authenticateCustomer(t);a?this.renderCardDetails():(jQuery(document.body).trigger("custom_action_to_refresh_checkout_email"),this.setPaymentMethod(this.paymentMethodId),this.renderCardForm(),this.scrolltobottom())}else jQuery(document.body).trigger("custom_action_to_refresh_checkout_email"),this.setPaymentMethod(this.paymentMethodId),this.renderCardForm(),this.scrolltobottom()}scrolltobottom(){jQuery("#place_order").length&&jQuery("html, body").animate({scrollTop:jQuery("#place_order").offset().top-500},1e3)}bindEmailLookupEvent(){jQuery(".fastlane-submit-button").off("click").on("click",async e=>{e.preventDefault();let t=jQuery("#fastlane-email");if(""===t.val().trim()){t.addClass("fastlane-input-error");return}t.removeClass("fastlane-input-error");let a=jQuery(".fastlane-submit-button");a.prop("disabled",!0);try{await this.processEmailLookup(),this.isPaymentMethodSet||this.setPaymentMethod(this.paymentMethodId)}catch(i){console.error("Error during email lookup event:",i)}finally{a.prop("disabled",!1)}})}bindWooCommerceEvents(){jQuery(document.body).on("updated_checkout ppcp_fastlane_checkout_updated",()=>{"angelleye_ppcp_fastlane"===$('input[name="radio-control-wc-payment-method-options"]:checked').val()&&(this.isCardDetailsRestored=!1,this.isPaymentMethodSet=!1,this.restoreCardDetails(),setTimeout(()=>{this.isPaymentMethodSet||this.setPaymentMethod(this.paymentMethodId)},200))})}render(){this.profileData?.card?this.renderCardDetails():this.renderCardForm()}}