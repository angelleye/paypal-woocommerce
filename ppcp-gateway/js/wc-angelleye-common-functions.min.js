const angelleyeOrder={isCheckoutPage:()=>"checkout"===angelleye_ppcp_manager.page,isProductPage:()=>"product"===angelleye_ppcp_manager.page,isCartPage:()=>"cart"===angelleye_ppcp_manager.page,isSale:()=>"capture"===angelleye_ppcp_manager.paymentaction,isOrderPayPage(){let e=new URL(window.location.href);return e.searchParams.has("pay_for_order")},isOrderCompletePage(){let e=new URL(window.location.href);return e.searchParams.has("paypal_order_id")},getSelectedPaymentMethod:()=>jQuery('input[name="payment_method"]:checked').val(),isApplePayPaymentMethodSelected:()=>"angelleye_ppcp_apple_pay"===angelleyeOrder.getSelectedPaymentMethod(),isPpcpPaymentMethodSelected:()=>"angelleye_ppcp"===angelleyeOrder.getSelectedPaymentMethod(),isAngelleyePpcpPaymentMethodSelected(){let e=angelleyeOrder.getSelectedPaymentMethod();return"angelleye_ppcp"===e||"angelleye_ppcp_apple_pay"===e},isAngelleyePaymentMethodSelected(){let e=angelleyeOrder.getSelectedPaymentMethod();return"paypal_express"===e||"angelleye_ppcp"===e||"angelleye_ppcp_apple_pay"===e},isApplePayEnabled:()=>""!==angelleye_ppcp_manager.apple_sdk_url,getCheckoutSelectorCss(){let e=".woocommerce";return"checkout"===angelleye_ppcp_manager.page&&(e="yes"===angelleye_ppcp_manager.is_pay_page?"form#order_review":"form.checkout"),e},scrollToWooCommerceNoticesSection(){let e=jQuery(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout");e.length||(e=jQuery("form.checkout")),e.length||(e=jQuery("form#order_review")),e.length&&jQuery("html, body").animate({scrollTop:e.offset().top-100},1e3)},createSmartButtonOrder:({angelleye_ppcp_button_selector:e})=>angelleyeOrder.createOrder({angelleye_ppcp_button_selector:e}).then(e=>e.orderID),createOrder({angelleye_ppcp_button_selector:e,billingDetails:r,shippingDetails:t,apiUrl:o,callback:a}){void 0===o&&(o=angelleye_ppcp_manager.create_order_url),jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove();let l,n=angelleyeOrder.isCheckoutPage(),c=angelleyeOrder.isProductPage();angelleyeOrder.isSale();let d=null,i=null;if(r&&(d=jQuery("<input>",{type:"hidden",name:"billing_address_source",value:JSON.stringify(r)})),t&&(i=jQuery("<input>",{type:"hidden",name:"shipping_address_source",value:JSON.stringify(t)})),n)l="#angelleye_ppcp_checkout_top"===e?"":jQuery(e).closest("form").serialize();else if(c){let s=jQuery("[name='add-to-cart']").val();jQuery("<input>",{type:"hidden",name:"angelleye_ppcp-add-to-cart",value:s}).appendTo("form.cart"),d&&(jQuery("form.cart").find("input[name=billing_address_source]").remove(),d.appendTo("form.cart")),i&&(jQuery("form.cart").find("input[name=shipping_address_source]").remove(),i.appendTo("form.cart")),l=jQuery("form.cart").serialize()}else d&&(jQuery("form.cart").find("input[name=billing_address_source]").remove(),d.appendTo("form.woocommerce-cart-form")),i&&(jQuery("form.cart").find("input[name=shipping_address_source]").remove(),i.appendTo("form.woocommerce-cart-form")),l=jQuery("form.woocommerce-cart-form").serialize();return fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l}).then(function(e){if(console.log("createOrder response",{res:e,apiUrl:o,redirected:e.redirected,url:e.url,status:e.status}),!e.redirected)return e.json();window.location.href=e.url}).then(function(e){if("function"==typeof a){a(e);return}if(void 0===e.success)return e;{let r=e.data.messages?e.data.messages:e.data;throw"string"!=typeof r&&(r="<div>Unable to create the order due to below errors.</div>"+(r=r.map(function(e){return"<li>"+e+"</li>"}).join(""))),Error(r)}})},approveOrder({orderID:e,payerID:r}){angelleyeOrder.isCheckoutPage()?jQuery.post(angelleye_ppcp_manager.cc_capture+"&paypal_order_id="+e+"&woocommerce-process-checkout-nonce="+angelleye_ppcp_manager.woocommerce_process_checkout,function(e){window.location.href=e.data.redirect}):"yes"===angelleye_ppcp_manager.is_skip_final_review?window.location.href=angelleye_ppcp_manager.direct_capture+"&paypal_order_id="+e+"&paypal_payer_id="+r+"&from="+angelleye_ppcp_manager.page:window.location.href=angelleye_ppcp_manager.checkout_url+"&paypal_order_id="+e+(r?"&paypal_payer_id="+r:"")+"&from="+angelleye_ppcp_manager.page},shippingAddressUpdate:e=>angelleyeOrder.createOrder({apiUrl:angelleye_ppcp_manager.shipping_update_url,shippingDetails:e}),onCancel(){jQuery(document.body).trigger("angelleye_paypal_oncancel"),!1===angelleyeOrder.isCheckoutPage()&&(angelleyeOrder.showProcessingSpinner(),window.location.reload())},prepareWooErrorMessage:e=>'<div class="woocommerce-error">'+e+"</div>",showError(e){e=angelleyeOrder.prepareWooErrorMessage(e);let r=angelleyeOrder.getCheckoutSelectorCss();jQuery(r).prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),jQuery(r).removeClass("processing").unblock(),jQuery(r).find(".input-text, select, input:checkbox").trigger("validate").trigger("blur"),angelleyeOrder.scrollToWooCommerceNoticesSection()},showProcessingSpinner(e){void 0===e&&(e=".woocommerce"),jQuery(e).length&&jQuery(e).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},hideProcessingSpinner(e){void 0===e&&(e=".woocommerce"),jQuery(e).length&&jQuery(e).unblock()},handleCreateOrderError(e){console.log(e),angelleyeOrder.hideProcessingSpinner(),jQuery(document.body).trigger("angelleye_paypal_onerror");let r=e.message;r.toLowerCase().indexOf("expected an order id to be passed")>-1&&0>r.toLowerCase().indexOf("required fields")&&(r="Unable to create the order, please contact the support."),""!==r&&angelleyeOrder.showError(r),angelleyeOrder.scrollToWooCommerceNoticesSection(),angelleyeOrder.isCheckoutPage()},isHostedFieldEligible:()=>!!angelleyeOrder.isCheckoutPage()&&"yes"===angelleye_ppcp_manager.advanced_card_payments&&"undefined"!=typeof angelleye_paypal_sdk&&void 0!==angelleye_paypal_sdk.HostedFields&&!0===angelleye_paypal_sdk.HostedFields.isEligible(),showPpcpPaymentMethods(){angelleyeOrder.isApplePayPaymentMethodSelected()?(jQuery("#angelleye_ppcp_checkout").hide(),jQuery("#angelleye_ppcp_checkout_apple_pay").show()):(jQuery("#angelleye_ppcp_checkout_apple_pay").hide(),jQuery("#angelleye_ppcp_checkout").show())},hidePpcpPaymentMethods(){jQuery("#angelleye_ppcp_checkout, #angelleye_ppcp_checkout_apple_pay").hide()},hideShowPlaceOrderButton(){let e=angelleyeOrder.getSelectedPaymentMethod();console.log("hideShowPlaceOrderButton",e);let r=angelleyeOrder.isAngelleyePpcpPaymentMethodSelected();!0===r&&jQuery(".wcf-pre-checkout-offer-action").val(""),!1===angelleyeOrder.isHostedFieldEligible()&&jQuery(".payment_method_angelleye_ppcp_cc").hide(),!0===r&&"no"===angelleye_ppcp_manager.is_checkout_disable_smart_button?(showHidePlaceOrderBtn(),angelleyeOrder.showPpcpPaymentMethods()):(angelleyeOrder.hidePpcpPaymentMethods(),showHidePlaceOrderBtn())},createHiddenInputField({fieldId:e,fieldName:r,fieldValue:t,fieldType:o,appendToSelector:a}){jQuery("#"+e).length>0&&jQuery("#"+e).remove(),jQuery("<input>",{type:void 0===o?"hidden":o,id:e,name:r,value:t}).appendTo(a)},getWooFormSelector(){let e="";return angelleyeOrder.isProductPage()?e="form.cart":angelleyeOrder.isCartPage()?e="form.woocommerce-cart-form":angelleyeOrder.isCheckoutPage()&&(e=angelleyeOrder.getCheckoutSelectorCss()),e},setPaymentMethodSelector(e){let r=angelleyeOrder.getWooFormSelector();angelleyeOrder.createHiddenInputField({fieldId:"angelleye_ppcp_payment_method_title",fieldName:"angelleye_ppcp_payment_method_title",fieldValue:e,appendToSelector:r})},renderSmartButton(){console.log("render smart buttons"),jQuery.each(angelleye_ppcp_manager.button_selector,function(e,r){if(!jQuery(r).length||jQuery(r).children().length||"undefined"==typeof angelleye_paypal_sdk)return;let t={layout:angelleye_ppcp_manager.style_layout,color:angelleye_ppcp_manager.style_color,shape:angelleye_ppcp_manager.style_shape,label:angelleye_ppcp_manager.style_label};""!==angelleye_ppcp_manager.style_height&&(t.height=parseInt(angelleye_ppcp_manager.style_height)),"vertical"!==angelleye_ppcp_manager.style_layout&&(t.tagline="yes"===angelleye_ppcp_manager.style_tagline),angelleye_paypal_sdk.Buttons({style:t,createOrder:function(e,t){return angelleyeOrder.createSmartButtonOrder({angelleye_ppcp_button_selector:r})},onApprove:function(e,r){angelleyeOrder.showProcessingSpinner(),angelleyeOrder.approveOrder(e)},onCancel:function(e,r){angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.onCancel()},onClick:function(e,r){angelleyeOrder.setPaymentMethodSelector(e.fundingSource)},onError:function(e){angelleyeOrder.handleCreateOrderError(e)}}).render(r),angelleyeOrder.isApplePayEnabled()&&new ApplePayCheckoutButton().render(r)})},renderHostedButtons(){let e=angelleyeOrder.getCheckoutSelectorCss();if(jQuery(e).is(".HostedFields"))return!1;"undefined"!=typeof angelleye_paypal_sdk&&(jQuery(e).addClass("HostedFields"),angelleye_paypal_sdk.HostedFields.render({createOrder:function(){if(jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),!1===jQuery(e).is(".createOrder")){jQuery(e).addClass("createOrder");let r;return angelleyeOrder.isCheckoutPage()&&(r=jQuery(e).serialize()),fetch(angelleye_ppcp_manager.create_order_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}).then(function(e){return e.json()}).then(function(e){if(void 0===e.success)return e.orderID;{let r=e.data.messages?e.data.messages:e.data;if("string"==typeof r)angelleyeOrder.showError(r);else{let t=r.map(function(e){return"<li>"+e+"</li>"}).join("");angelleyeOrder.showError("<ul>"+t+"</ul>")}return""}})}},onCancel:function(e,r){r.redirect(angelleye_ppcp_manager.cancel_url)},onError:function(e){console.log(e)},styles:{input:{"font-size":"1.3em"}},fields:{number:{selector:"#angelleye_ppcp_cc-card-number",placeholder:"•••• •••• •••• ••••",addClass:"input-text wc-credit-card-form-card-number"},cvv:{selector:"#angelleye_ppcp_cc-card-cvc",placeholder:"CVC"},expirationDate:{selector:"#angelleye_ppcp_cc-card-expiry",placeholder:"MM / YY"}}}).then(function(r){r.on("cardTypeChange",function(r){if(r.cards.length>0){let t=r.cards[0].type.replace("master-card","mastercard").replace("american-express","amex").replace("diners-club","dinersclub").replace("-","");-1!==jQuery.inArray(t,angelleye_ppcp_manager.disable_cards)?(jQuery("#angelleye_ppcp_cc-card-number").addClass("ppcp-invalid-cart"),jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),angelleyeOrder.showError(angelleye_ppcp_manager.card_not_supported)):(jQuery("#angelleye_ppcp_cc-card-number").removeClass().addClass(t),jQuery("#angelleye_ppcp_cc-card-number").addClass("input-text wc-credit-card-form-card-number hosted-field-braintree braintree-hosted-fields-valid"));let o;"product"===angelleye_ppcp_manager.page?o="form.cart":"cart"===angelleye_ppcp_manager.page?o="form.woocommerce-cart-form":"checkout"===angelleye_ppcp_manager.page&&(o="yes"===angelleye_ppcp_manager.is_pay_page?"#order_review":e),jQuery("#angelleye_ppcp_cc_cc_payment_method_title").length>0&&jQuery("#angelleye_ppcp_cc_cc_payment_method_title").empty(),jQuery("<input>",{type:"hidden",id:"angelleye_ppcp_cc_payment_method_title",name:"angelleye_ppcp_cc_payment_method_title",value:angelleye_ppcp_manager.advanced_card_payments_title}).appendTo(o)}}),jQuery(document.body).on("submit_paypal_cc_form",function(t){t.preventDefault();let o=r.getState();if(void 0!==o.cards){if(o.fields.number.isValid){let a=o.cards[0].type;if((null!=a||0!==a.length)&&-1!==jQuery.inArray(a,angelleye_ppcp_manager.disable_cards)){jQuery(e).removeClass("processing paypal_cc_submiting HostedFields createOrder").unblock(),jQuery("#angelleye_ppcp_cc-card-number").addClass("ppcp-invalid-cart"),jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),angelleyeOrder.showError(angelleye_ppcp_manager.card_not_supported);return}}}else{jQuery(e).removeClass("processing paypal_cc_submiting HostedFields createOrder").unblock(),jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),angelleyeOrder.showError(angelleye_ppcp_manager.fields_not_valid);return}if(!1===Object.keys(o.fields).every(function(e){return o.fields[e].isValid})){jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),jQuery(e).removeClass("processing paypal_cc_submiting HostedFields createOrder").unblock(),angelleyeOrder.showError(angelleye_ppcp_manager.fields_not_valid);return}let l=[];l=[angelleye_ppcp_manager.three_d_secure_contingency],jQuery(e).addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),angelleyeOrder.scrollToWooCommerceNoticesSection();let n,c;"yes"===angelleye_ppcp_manager.is_pay_page?(n=angelleye_ppcp_manager.first_name,c=angelleye_ppcp_manager.last_name):(n=document.getElementById("billing_first_name")?document.getElementById("billing_first_name").value:"",c=document.getElementById("billing_last_name")?document.getElementById("billing_last_name").value:""),r.submit({contingencies:l,cardholderName:n+" "+c}).then(function(e){e.orderId&&jQuery.post(angelleye_ppcp_manager.cc_capture+"&paypal_order_id="+e.orderId+"&woocommerce-process-checkout-nonce="+angelleye_ppcp_manager.woocommerce_process_checkout+"&is_pay_page="+angelleye_ppcp_manager.is_pay_page,function(e){window.location.href=e.data.redirect})},function(r){jQuery(e).removeClass("processing paypal_cc_submiting HostedFields createOrder").unblock();let t="";Array.isArray(r.details)&&r.details[0].description?t=r.details[0].description:r.message&&(t=r.message),Array.isArray(r.details)&&"INVALID_RESOURCE_ID"===r.details[0].issue&&(t=""),""!==t&&angelleyeOrder.showError(t)})})}).catch(function(e){console.log("error: ",JSON.stringify(e))}))},async applePayDataInit(){if(angelleyeOrder.isApplePayEnabled()){angelleyeOrder.showProcessingSpinner("#angelleye_ppcp_cart_apple_pay");let e=await angelleyeOrder.shippingAddressUpdate({});angelleyeOrder.hideProcessingSpinner("#angelleye_ppcp_cart_apple_pay"),void 0!==e.totalAmount?window.angelleye_cart_totals=e:window.location.reload()}},queuedEvents:{},addEventsForCallback(e,r,t){angelleyeOrder.queuedEvents[e]={event:r,data:t}},dequeueEvent(e){e in angelleyeOrder.queuedEvents&&delete angelleyeOrder.queuedEvents[e]},isPendingEventTriggering:!1,triggerPendingEvents(){for(let e in angelleyeOrder.isPendingEventTriggering=!0,angelleyeOrder.queuedEvents)angelleyeOrder.queuedEvents[e].data?jQuery(document.body).trigger(e,[angelleyeOrder.queuedEvents[e].data]):jQuery(document.body).trigger(e)},hooks:{onPaymentMethodChange(){jQuery(document.body).on("updated_cart_totals payment_method_selected updated_checkout",function(e){angelleyeOrder.dequeueEvent(e.type),angelleyeOrder.hideShowPlaceOrderButton(),setTimeout(function(){angelleyeOrder.renderSmartButton(),!0===angelleyeOrder.isHostedFieldEligible()&&(0===jQuery("#angelleye_ppcp_cc-card-number iframe").length&&jQuery(angelleyeOrder.getCheckoutSelectorCss()).removeClass("HostedFields"),jQuery(".checkout_cc_separator").show(),jQuery("#wc-angelleye_ppcp-cc-form").show(),angelleyeOrder.renderHostedButtons())},300)}),angelleyeOrder.isCartPage()&&jQuery(document.body).on("updated_cart_totals",async function(e){angelleyeOrder.dequeueEvent(e.type),await angelleyeOrder.applePayDataInit()})},onCartValueUpdate(){jQuery(document.body).on("updated_checkout",function(e,r){angelleyeOrder.dequeueEvent(e.type),void 0!==r&&void 0!==r.fragments&&void 0!==r.fragments.angelleye_payments_data&&(window.angelleye_cart_totals=JSON.parse(r.fragments.angelleye_payments_data)),console.log("cart updated",r,window.angelleye_cart_totals)})},handleRaceConditionOnWooHooks(){jQuery(document.body).on("updated_cart_totals payment_method_selected updated_checkout",function(e,r){angelleyeOrder.isPendingEventTriggering||angelleyeOrder.addEventsForCallback(e.type,e,r)})}}};
