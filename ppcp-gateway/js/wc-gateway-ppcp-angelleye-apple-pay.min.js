class ApplePayCheckoutButton{static applePayConfig;static isConfigLoading;static configPromise;static applePayObject;constructor(){}async initApplePayConfig(){return ApplePayCheckoutButton.isConfigLoading?(ApplePayCheckoutButton.configPromise||(ApplePayCheckoutButton.configPromise=new Promise((e,t)=>{let a=setInterval(()=>{ApplePayCheckoutButton.applePayConfig&&(e(ApplePayCheckoutButton.applePayConfig),clearInterval(a))},100)})),ApplePayCheckoutButton.configPromise):(ApplePayCheckoutButton.applePayConfig||(ApplePayCheckoutButton.isConfigLoading=!0,ApplePayCheckoutButton.applePayConfig=await ApplePayCheckoutButton.applePay().config()),ApplePayCheckoutButton.applePayConfig)}static applePay(){return ApplePayCheckoutButton.applePayObject||(ApplePayCheckoutButton.applePayObject=angelleye_paypal_sdk.Applepay()),ApplePayCheckoutButton.applePayObject}render(e){"undefined"!=typeof ApplePaySession&&ApplePaySession?.supportsVersion(4)&&ApplePaySession?.canMakePayments()?this.initApplePayConfig().then(()=>{if(!ApplePayCheckoutButton.applePayConfig.isEligible){this.removeApplePayPaymentMethod();return}this.showApplePayPaymentMethod(),this.renderButton(e)}):(console.log("apple pay not supported"),this.removeApplePayPaymentMethod(e))}showApplePayPaymentMethod(){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_apple_pay").show()}removeApplePayPaymentMethod(e){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_apple_pay").hide(),jQuery(e).length&&jQuery(e).remove()}renderButton(e){this.containerSelector=e,this.initProductCartPage();let t=jQuery(e);t.html(""),console.log("rendering apple_pay button",e,t);let a="black",n="plain",p="";if(void 0!==angelleye_ppcp_manager.apple_pay_button_props){a=angelleye_ppcp_manager.apple_pay_button_props.buttonColor,n=angelleye_ppcp_manager.apple_pay_button_props.buttonType;let o=angelleye_ppcp_manager.apple_pay_button_props.height;p=o=""!==o?"height: "+o+"px;":""}let i=jQuery('<div class="apple-pay-container" style="'+(""!==p?p:"")+'"></div>'),l=jQuery('<apple-pay-button id="btn-appl" buttonstyle="'+a+'" type="'+n+'" locale="en">');l.on("click",{thisObject:this},this.handleClickEvent),i.append(l),t.append(i)}initProductCartPage(){}static addPaymentMethodSaveParams(){let e=jQuery("input#wc-angelleye_ppcp_apple_pay-new-payment-method:checked").val(),t=angelleyeOrder.getCartDetails();return"true"===e||t.isSubscriptionRequired?{recurringPaymentRequest:{paymentDescription:angelleye_ppcp_manager.apple_pay_recurring_params.paymentDescription,regularBilling:{label:"Recurring",amount:`${t.totalAmount}`,paymentTiming:"recurring",recurringPaymentStartDate:new Date},billingAgreement:angelleye_ppcp_manager.apple_pay_recurring_params.billingAgreement,managementURL:angelleye_ppcp_manager.apple_pay_recurring_params.managementURL,tokenNotificationURL:ApplePayCheckoutButton.applePayConfig.tokenNotificationURL}}:{}}async handleClickEvent(e){let t=e.data.thisObject.containerSelector,a=angelleyeOrder.getCartDetails();angelleyeOrder.showProcessingSpinner(),angelleyeOrder.setPaymentMethodSelector("apple_pay");let n=jQuery("input[name=wc-angelleye_ppcp_apple_pay-payment-token]:checked").val();if(console.log("isSavedPaymentMethodSelected",n),"new"!==n&&void 0!==n){await ApplePayCheckoutButton.handleTokenPayment(e);return}a.totalAmount<=0&&angelleyeOrder.showError("Your shopping cart seems to be empty.");let p=[];a.shippingRequired&&(p=["postalAddress","name","email"]);let o=ApplePayCheckoutButton.addPaymentMethodSaveParams(),i={countryCode:ApplePayCheckoutButton.applePayConfig.countryCode,currencyCode:a.currencyCode,merchantCapabilities:ApplePayCheckoutButton.applePayConfig.merchantCapabilities,supportedNetworks:ApplePayCheckoutButton.applePayConfig.supportedNetworks,requiredBillingContactFields:["name","phone","email","postalAddress"],requiredShippingContactFields:p,total:{label:"Total Amount",amount:`${a.totalAmount}`,type:"final"},lineItems:a.lineItems,...o};console.log("paymentRequest",ApplePayCheckoutButton.applePayConfig,i);let l=null;try{l=new ApplePaySession(4,i)}catch(r){console.log("ApplePay error session init error: ",r),angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError("An error occurred while initiating the ApplePay payment.<br/>Error: "+r);return}let c=e=>{if(console.error(e),console.log(JSON.stringify(e)),"PayPalApplePayError"===e.name){let t=e.paypalDebugId;return"ERROR_VALIDATING_MERCHANT"===e.errorName?"This merchant is not enabled to process apple pay. please contact website owner. [DebugId: "+t+"]":"We are unable to process your request at the moment, please contact website owner. [DebugId: "+t+"]"}return e};l.onvalidatemerchant=e=>{ApplePayCheckoutButton.applePay().validateMerchant({validationUrl:e.validationURL}).then(e=>{l.completeMerchantValidation(e.merchantSession)}).catch(e=>{angelleyeOrder.hideProcessingSpinner();let t=c(e);angelleyeOrder.showError(t),l.abort()})},l.onpaymentmethodselected=e=>{l.completePaymentMethodSelection({newTotal:i.total})},l.onshippingcontactselected=async e=>{let t=angelleyeOrder.getCartDetails();console.log("on shipping contact selected",e);let a={label:"Total Amount",amount:`${t.totalAmount}`,type:"final"};try{let n=await angelleyeOrder.shippingAddressUpdate({shippingDetails:e.shippingContact});if(console.log("shipping update response",n),void 0!==n.totalAmount){angelleyeOrder.updateCartTotalsInEnvironment(n),a.amount=n.totalAmount;let p={newTotal:a,newLineItems:n.lineItems,errors:[]};console.log("updating total amount",p),Object.assign(i,{total:a,lineItems:n.lineItems}),l.completeShippingContactSelection(p)}else throw Error("Unable to update the shipping amount.")}catch(o){let r=c(o);angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(r),l.completePayment({status:ApplePaySession.STATUS_FAILURE})}},l.onshippingmethodselected=async e=>{console.log("on shipping method selected",e),l.completeShippingMethodSelection({})},l.onpaymentauthorized=async e=>{try{console.log("paymentAuthorized",e);let a=await angelleyeOrder.createOrder({angelleye_ppcp_button_selector:t,billingDetails:e.payment.billingContact,shippingDetails:e.payment.shippingContact}).then(e=>(console.log("orderCreated",e),e.orderID));await ApplePayCheckoutButton.applePay().confirmOrder({orderId:a,token:e.payment.token,billingContact:e.payment.billingContact,shippingContact:e.payment.shippingContact}),await l.completePayment({status:ApplePaySession.STATUS_SUCCESS}),angelleyeOrder.approveOrder({orderID:a,payerID:""})}catch(n){angelleyeOrder.triggerPaymentCancelEvent();let p=c(n);angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(p),l.completePayment({status:ApplePaySession.STATUS_FAILURE})}},l.oncancel=e=>{console.log("Apple Pay Cancelled !!",e),angelleyeOrder.hideProcessingSpinner()},l.begin()}static async handleTokenPayment(e){let t=e.data.thisObject.containerSelector;angelleyeOrder.createOrder({angelleye_ppcp_button_selector:t,callback(){}}).catch(e=>{angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(e)})}}
