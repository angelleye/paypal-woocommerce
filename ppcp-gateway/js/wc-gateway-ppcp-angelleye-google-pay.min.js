class GooglePayCheckoutButton{static googlePayConfig;static isConfigLoading;static configPromise;static googlePayObject;static baseRequest={apiVersion:2,apiVersionMinor:0};constructor(){}async initGooglePayConfig(){return GooglePayCheckoutButton.isConfigLoading?(GooglePayCheckoutButton.configPromise||(GooglePayCheckoutButton.configPromise=new Promise((e,t)=>{let o=setInterval(()=>{GooglePayCheckoutButton.googlePayConfig&&(e(GooglePayCheckoutButton.googlePayConfig),clearInterval(o))},100)})),GooglePayCheckoutButton.configPromise):(GooglePayCheckoutButton.googlePayConfig||(GooglePayCheckoutButton.isConfigLoading=!0,GooglePayCheckoutButton.googlePayConfig=await GooglePayCheckoutButton.googlePay().config()),GooglePayCheckoutButton.googlePayConfig)}static googlePay(){return GooglePayCheckoutButton.googlePayObject||(GooglePayCheckoutButton.googlePayObject=angelleye_paypal_sdk.Googlepay()),GooglePayCheckoutButton.googlePayObject}render(e){console.log("containerSelector",e),this.initGooglePayConfig().then(()=>{let t=this.getGooglePaymentsClient(),o=GooglePayCheckoutButton.googlePayConfig.allowedPaymentMethods;t.isReadyToPay(this.getGoogleIsReadyToPayRequest(o)).then(t=>{console.log("isReadyToPay",t),t.result&&(this.showGooglePayPaymentMethod(),this.renderButton(e))}).catch(t=>{console.error("errorcatch",t),this.removeGooglePayPaymentMethod(e)})})}getGoogleIsReadyToPayRequest(e){return Object.assign({},GooglePayCheckoutButton.baseRequest,{allowedPaymentMethods:e})}isShippingRequired(){return!angelleyeOrder.isCheckoutPage()&&window.angelleye_cart_totals&&void 0!==window.angelleye_cart_totals.shippingRequired&&window.angelleye_cart_totals.shippingRequired}getGooglePaymentsClient(e){return console.log("onPaymentAuthorized",this.containerSelector,e),new google.payments.api.PaymentsClient({environment:"1"===angelleye_ppcp_manager.sandbox_mode?"TEST":"PRODUCTION",paymentDataCallbacks:{onPaymentDataChanged:this.isShippingRequired()?this.onPaymentDataChanged.bind(null,{thisObject:this,orderID:e&&e.orderID?e.orderID:null}):null,onPaymentAuthorized:this.onPaymentAuthorized.bind(null,{thisObject:this,orderID:e&&e.orderID?e.orderID:null})}})}showGooglePayPaymentMethod(){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_google_pay").show()}removeGooglePayPaymentMethod(e){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_google_pay").hide(),jQuery(e).length&&jQuery(e).remove()}onPaymentAuthorized(e,t){console.log("onPaymentAuthorized",e,t);let o=e=>(console.error("parseErrorMessage",e),console.log(JSON.stringify(e)),e);return new Promise((a,n)=>{angelleyeOrder.showProcessingSpinner(),e.thisObject.processPayment(e,t).then(function(e){a({transactionState:"SUCCESS"})}).catch(function(e){let t=o(e);angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(t),a({transactionState:"ERROR"})})})}onPaymentDataChanged(e,t){return new Promise(async function(o,a){console.log("on shipping changed",t);let n=t.shippingAddress,r={};if("INITIALIZE"==t.callbackTrigger||"SHIPPING_ADDRESS"==t.callbackTrigger)try{let i=await angelleyeOrder.shippingAddressUpdate({shippingDetails:{administrativeArea:n.administrativeArea,countryCode:n.countryCode,locality:n.locality,postalCode:n.postalCode}});if(void 0!==i.totalAmount)window.angelleye_cart_totals=i,r.newTransactionInfo=e.thisObject.getGoogleTransactionInfo();else throw Error("Unable to update the shipping amount.")}catch(l){angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(l),r.error="Unable to pull the shipping amount details based on selected address",a("Unable to pull the shipping amount details based on selected address")}o(r)})}async processPayment(e,t){try{console.log("processPayment",e,JSON.stringify(t));let{status:o}=await GooglePayCheckoutButton.googlePay().confirmOrder({orderId:e.orderID,paymentMethodData:t.paymentMethodData});if("APPROVED"!==o)return{transactionState:"ERROR"};if(!angelleyeOrder.isCheckoutPage()){let a,n=t.shippingAddress;t.paymentMethodData&&t.paymentMethodData.info&&t.paymentMethodData.info.billingAddress&&(a=t.paymentMethodData.info.billingAddress),t.email&&(a||(a={}),a.emailAddress=t.email),await angelleyeOrder.shippingAddressUpdate({shippingDetails:n},{billingDetails:a})}return angelleyeOrder.approveOrder({orderID:e.orderID,payerID:""}),{transactionState:"SUCCESS"}}catch(r){return console.log("processPaymentError",r),angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(r),{transactionState:"ERROR",error:{message:r.message}}}}renderButton(e){this.containerSelector=e,this.initProductCartPage();let t=jQuery(e);t.html(""),console.log("rendering google_pay button",e,t);let o="default",a="plain",n="";if(void 0!==angelleye_ppcp_manager.google_pay_button_props){o=angelleye_ppcp_manager.google_pay_button_props.buttonColor,a=angelleye_ppcp_manager.google_pay_button_props.buttonType;let r=angelleye_ppcp_manager.google_pay_button_props.height;n=r=""!==r?"height: "+r+"px;":""}let i=jQuery('<div class="google-pay-container" style="'+(""!=n?n:"")+'"></div>'),l=this,s=this.getGooglePaymentsClient(),g=s.createButton({buttonColor:o,buttonType:a,buttonSizeMode:"fill",async onClick(e){await l.handleClickEvent(e,l)}});i.append(g),t.append(i)}initProductCartPage(){(angelleyeOrder.isProductPage()||angelleyeOrder.isCartPage()||angelleyeOrder.isOrderPayPage())&&(window.angelleye_cart_totals=angelleye_ppcp_manager.product_cart_details)}getGoogleTransactionInfo(){let e=[];for(let t=0;t<window.angelleye_cart_totals.lineItems.length;t++){let o="LINE_ITEM";"tax"===window.angelleye_cart_totals.lineItems[t].label.toLowerCase()&&(o="TAX"),e.push({label:window.angelleye_cart_totals.lineItems[t].label,price:window.angelleye_cart_totals.lineItems[t].amount,type:o})}return{displayItems:e,currencyCode:window.angelleye_cart_totals.currencyCode,totalPriceStatus:"FINAL",totalPrice:window.angelleye_cart_totals.totalAmount,totalPriceLabel:"Total"}}getGooglePaymentDataRequest(){let e=Object.assign({},GooglePayCheckoutButton.baseRequest);return e.allowedPaymentMethods=GooglePayCheckoutButton.googlePayConfig.allowedPaymentMethods,e.transactionInfo=this.getGoogleTransactionInfo(),e.merchantInfo=GooglePayCheckoutButton.googlePayConfig.merchantInfo,e.emailRequired=!0,e.callbackIntents=["PAYMENT_AUTHORIZATION"],this.isShippingRequired()&&(e.callbackIntents.push("SHIPPING_ADDRESS"),e.shippingAddressRequired=!0),e}async handleClickEvent(e,t){console.log("click event",e,t.containerSelector),window.angelleye_cart_totals.totalAmount<=0&&angelleyeOrder.showError("Your shopping cart seems to be empty."),angelleyeOrder.setPaymentMethodSelector("google_pay");let o;try{angelleyeOrder.showProcessingSpinner(),o=await angelleyeOrder.createOrder({angelleye_ppcp_button_selector:t.containerSelector}).then(e=>(console.log("orderCreated",e),angelleye_ppcp_manager.product_cart_details=e,t.initProductCartPage(),e.orderID))}catch(a){a=a.message,angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(a);return}let n=t.getGooglePaymentDataRequest(),r=t.getGooglePaymentsClient({orderID:o});r.loadPaymentData(n).then(e=>{console.log("success",e)},e=>{angelleyeOrder.triggerPaymentCancelEvent(),angelleyeOrder.hideProcessingSpinner(t.containerSelector),angelleyeOrder.hideProcessingSpinner(),console.log("error handler click",e)})}}
