class GooglePayCheckoutButton{static googlePayConfig;static isConfigLoading;static configPromise;static googlePayObject;static baseRequest={apiVersion:2,apiVersionMinor:0};constructor(){}async initGooglePayConfig(){return GooglePayCheckoutButton.isConfigLoading?(GooglePayCheckoutButton.configPromise||(GooglePayCheckoutButton.configPromise=new Promise((e,t)=>{let o=setInterval(()=>{GooglePayCheckoutButton.googlePayConfig&&(e(GooglePayCheckoutButton.googlePayConfig),clearInterval(o))},100)})),GooglePayCheckoutButton.configPromise):(GooglePayCheckoutButton.googlePayConfig||(GooglePayCheckoutButton.isConfigLoading=!0,GooglePayCheckoutButton.googlePayConfig=await GooglePayCheckoutButton.googlePay().config()),GooglePayCheckoutButton.googlePayConfig)}static googlePay(){return GooglePayCheckoutButton.googlePayObject||(GooglePayCheckoutButton.googlePayObject=angelleye_paypal_sdk.Googlepay()),GooglePayCheckoutButton.googlePayObject}render(e){0!==jQuery(e).length&&this.initGooglePayConfig().then(()=>{let t=this.getGooglePaymentsClient(),o=GooglePayCheckoutButton.googlePayConfig.allowedPaymentMethods;t.isReadyToPay(this.getGoogleIsReadyToPayRequest(o)).then(t=>{t.result&&(this.showGooglePayPaymentMethod(),this.renderButton(e))}).catch(t=>{console.error("errorcatch",t),this.removeGooglePayPaymentMethod(e)})})}getGoogleIsReadyToPayRequest(e){return Object.assign({},GooglePayCheckoutButton.baseRequest,{allowedPaymentMethods:e})}isShippingRequired(){let e=angelleyeOrder.getCartDetails();return!angelleyeOrder.isCheckoutPage()&&e&&void 0!==e.shippingRequired&&e.shippingRequired}getGooglePaymentsClient(e){return new google.payments.api.PaymentsClient({environment:"1"===angelleye_ppcp_manager.sandbox_mode?"TEST":"PRODUCTION",paymentDataCallbacks:{onPaymentDataChanged:this.isShippingRequired()?this.onPaymentDataChanged.bind(null,{thisObject:this}):null,onPaymentAuthorized:this.onPaymentAuthorized.bind(null,{thisObject:this})}})}showGooglePayPaymentMethod(){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_google_pay").show()}removeGooglePayPaymentMethod(e){angelleyeOrder.isCheckoutPage()&&jQuery(".wc_payment_method.payment_method_angelleye_ppcp_google_pay").hide(),jQuery(e).length&&jQuery(e).remove()}parseErrorMessage(e){if(console.log(e,JSON.stringify(e)),"PayPalGooglePayError"===e.name){let t=e.paypalDebugId;return"ERROR_VALIDATING_MERCHANT"===e.errorName?localizedMessages.error_validating_merchant+" [GooglePay DebugId:"+t+"]":localizedMessages.general_error_message+" [GooglePay DebugId:"+t+"]"}return e}onPaymentAuthorized(e,t){return console.log("onPaymentAuthorized",e,t),new Promise((o,a)=>{angelleyeOrder.showProcessingSpinner(),e.thisObject.processPayment(e,t).then(function(e){o({transactionState:"SUCCESS"})}).catch(function(t){let a=e.thisObject.parseErrorMessage(t);angelleyeOrder.hideProcessingSpinner(),angelleyeOrder.showError(a),o({transactionState:"ERROR"})})})}onPaymentDataChanged(e,t){return new Promise(async function(o,a){console.log("on shipping changed",t);let n=t.shippingAddress,r={};if("INITIALIZE"==t.callbackTrigger||"SHIPPING_ADDRESS"==t.callbackTrigger)try{let i=await angelleyeOrder.shippingAddressUpdate({shippingDetails:{administrativeArea:n.administrativeArea,countryCode:n.countryCode,locality:n.locality,postalCode:n.postalCode}});if(void 0!==i.totalAmount)angelleyeOrder.updateCartTotalsInEnvironment(i),r.newTransactionInfo=e.thisObject.getGoogleTransactionInfo();else throw Error(localizedMessages.shipping_amount_update_error)}catch(l){console.log("shipping change error"),angelleyeOrder.handleCreateOrderError(e.thisObject.parseErrorMessage(l),e.thisObject.errorLogId),r.error=localizedMessages.shipping_amount_pull_error,a(localizedMessages.shipping_amount_pull_error)}o(r)})}async processPayment(e,t){try{console.log("processPayment",e,JSON.stringify(t));let o=e.thisObject;angelleyeOrder.showProcessingSpinner();let a=await angelleyeOrder.createOrder({angelleye_ppcp_button_selector:o.containerSelector,errorLogId:e.thisObject.errorLogId}).then(e=>(console.log("orderCreated",e),angelleyeOrder.updateCartTotalsInEnvironment(e),e.orderID)),{status:n}=await GooglePayCheckoutButton.googlePay().confirmOrder({orderId:a,paymentMethodData:t.paymentMethodData});if("APPROVED"!==n)return{transactionState:"ERROR"};if(!angelleyeOrder.isCheckoutPage()){let r,i=t.shippingAddress;t.paymentMethodData&&t.paymentMethodData.info&&t.paymentMethodData.info.billingAddress&&(r=t.paymentMethodData.info.billingAddress),t.email&&(r||(r={}),r.emailAddress=t.email),await angelleyeOrder.shippingAddressUpdate({shippingDetails:i},{billingDetails:r},e.thisObject.errorLogId)}return angelleyeOrder.approveOrder({orderID:a,payerID:""}),{transactionState:"SUCCESS"}}catch(l){return console.log("processPaymentError",l),angelleyeOrder.handleCreateOrderError(e.thisObject.parseErrorMessage(l),e.thisObject.errorLogId),{transactionState:"ERROR",error:{message:l.message}}}}renderButton(e){this.containerSelector=e;let t=jQuery(e);t.html("");let o="default",a="plain",n="";if(void 0!==angelleye_ppcp_manager.google_pay_button_props){o=angelleye_ppcp_manager.google_pay_button_props.buttonColor,a=angelleye_ppcp_manager.google_pay_button_props.buttonType;let r=angelleye_ppcp_manager.google_pay_button_props.height;n=r=""!==r?"height: "+r+"px;":""}let i=jQuery('<div class="google-pay-container" style="'+(""!=n?n:"")+'"></div>'),l=this,g=this.getGooglePaymentsClient(),s=g.createButton({buttonColor:o,buttonType:a,buttonSizeMode:"fill",async onClick(e){await l.handleClickEvent(e,l)}});i.append(s),t.append(i)}getGoogleTransactionInfo(){let e=[],t=angelleyeOrder.getCartDetails();for(let o=0;o<t.lineItems.length;o++){let a="LINE_ITEM";"tax"===t.lineItems[o].label.toLowerCase()&&(a="TAX"),e.push({label:t.lineItems[o].label,price:t.lineItems[o].amount,type:a})}return{displayItems:e,currencyCode:t.currencyCode,totalPriceStatus:"FINAL",totalPrice:t.totalAmount,totalPriceLabel:"Total"}}getGooglePaymentDataRequest(){let e=Object.assign({},GooglePayCheckoutButton.baseRequest);return e.allowedPaymentMethods=GooglePayCheckoutButton.googlePayConfig.allowedPaymentMethods,e.transactionInfo=this.getGoogleTransactionInfo(),e.merchantInfo=GooglePayCheckoutButton.googlePayConfig.merchantInfo,e.emailRequired=!0,e.callbackIntents=["PAYMENT_AUTHORIZATION"],this.isShippingRequired()&&(e.callbackIntents.push("SHIPPING_ADDRESS"),e.shippingAddressRequired=!0),e}async handleClickEvent(e,t){console.log("click event",e,t.containerSelector),t.errorLogId=angelleyeJsErrorLogger.generateErrorId();let o=angelleyeOrder.getCartDetails();o.totalAmount<=0&&angelleyeOrder.showError(localizedMessages.empty_cart_message),angelleyeJsErrorLogger.addToLog(t.errorLogId,"Google Pay Payment Started"),angelleyeOrder.setPaymentMethodSelector("google_pay");let a=t.getGooglePaymentDataRequest(),n=t.getGooglePaymentsClient({});n.loadPaymentData(a).then(e=>{console.log("success",e)},e=>{angelleyeOrder.triggerPaymentCancelEvent(),angelleyeOrder.hideProcessingSpinner(t.containerSelector),angelleyeOrder.hideProcessingSpinner(),console.log("error handler click",e)})}}
